version: '3.8'

services:
  pending-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: certen-pending-service
    restart: unless-stopped
    environment:
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - GOOGLE_APPLICATION_CREDENTIALS=/secrets/service-account.json
      - ACCUMULATE_API_URL=${ACCUMULATE_API_URL:-https://mainnet.accumulatenetwork.io/v3}
      - ACCUMULATE_NETWORK=${ACCUMULATE_NETWORK:-mainnet}
      - POLL_INTERVAL_SEC=${POLL_INTERVAL_SEC:-600}
      - USER_CONCURRENCY=${USER_CONCURRENCY:-8}
      - MAX_RETRIES=${MAX_RETRIES:-3}
      - DELEGATION_DEPTH=${DELEGATION_DEPTH:-10}
      - PENDING_PAGE_SIZE=${PENDING_PAGE_SIZE:-100}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - DRY_RUN=${DRY_RUN:-false}
    volumes:
      - ./secrets:/secrets:ro
    networks:
      - certen-network
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Optional: Firestore emulator for local development
  firestore-emulator:
    image: gcr.io/google.com/cloudsdktool/cloud-sdk:emulators
    container_name: firestore-emulator
    command: gcloud emulators firestore start --host-port=0.0.0.0:8080
    ports:
      - "8080:8080"
    profiles:
      - dev
    networks:
      - certen-network

networks:
  certen-network:
    driver: bridge
